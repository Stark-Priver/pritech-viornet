name: Release â€” All Platforms

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers on every push to main.
# The entire pipeline only runs when the commit message contains
# the word  "release"  (case-insensitive).
# You can also embed the target version in the message, e.g.:
#   "release v1.2.0 â€” new dashboard"
# If no version is found the patch number is auto-incremented from
# the latest GitHub release tag (starting after v1.1.1).
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [ "main" ]

env:
  FLUTTER_VERSION: '3.38.7'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 0 â”€ PREPARE  (version resolution â€” runs only when "release" found)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  prepare:
    name: Resolve Version
    if: ${{ contains(github.event.head_commit.message, 'release') }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release version
        id: ver
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MSG="${{ github.event.head_commit.message }}"

          # Check if the commit message contains an explicit version tag
          if echo "$MSG" | grep -oP 'v\d+\.\d+\.\d+' > /dev/null 2>&1; then
            VERSION=$(echo "$MSG" | grep -oP 'v\d+\.\d+\.\d+' | head -1)
            echo "Using version from commit message: $VERSION"
          else
            # Fetch the latest release tag via the GitHub API
            LATEST=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")
            if [ -z "$LATEST" ]; then
              # Fall back to git tags
              LATEST=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
            fi
            if [ -z "$LATEST" ]; then
              VERSION="v1.1.2"
            else
              MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
              MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
              PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)
              PATCH=$((PATCH + 1))
              VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            fi
            echo "Auto-incremented version: $VERSION (from $LATEST)"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1 â”€ ANDROID
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  android:
    name: Build Android APK
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build APK (release)
        run: flutter build apk --release

      - name: Rename artifact
        run: |
          mkdir -p artifacts
          cp build/app/outputs/flutter-apk/app-release.apk \
             artifacts/ViorNet-${{ needs.prepare.outputs.version }}-android.apk

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts/ViorNet-${{ needs.prepare.outputs.version }}-android.apk
          retention-days: 1

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2 â”€ iOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ios:
    name: Build iOS IPA
    needs: prepare
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build iOS (no-codesign)
        run: flutter build ios --release --no-codesign

      - name: Package IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ViorNet-${{ needs.prepare.outputs.version }}-ios.ipa Payload
          mkdir -p ../../../artifacts
          cp ViorNet-${{ needs.prepare.outputs.version }}-ios.ipa ../../../artifacts/

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: artifacts/ViorNet-${{ needs.prepare.outputs.version }}-ios.ipa
          retention-days: 1

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3 â”€ WEB
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  web:
    name: Build Web
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Web
        run: flutter build web --release --web-renderer canvaskit

      - name: Package Web
        run: |
          mkdir -p artifacts
          cd build/web
          zip -r ../../artifacts/ViorNet-${{ needs.prepare.outputs.version }}-web.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: artifacts/ViorNet-${{ needs.prepare.outputs.version }}-web.zip
          retention-days: 1

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4 â”€ WINDOWS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  windows:
    name: Build Windows
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Windows
        run: flutter build windows --release

      - name: Package Windows
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $src = "build\windows\x64\runner\Release"
          $zip = "artifacts\ViorNet-${{ needs.prepare.outputs.version }}-windows.zip"
          Compress-Archive -Path "$src\*" -DestinationPath $zip

      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: artifacts/ViorNet-${{ needs.prepare.outputs.version }}-windows.zip
          retention-days: 1

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5 â”€ LINUX
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  linux:
    name: Build Linux
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Linux
        run: flutter build linux --release

      - name: Package Linux
        run: |
          mkdir -p artifacts
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../artifacts/ViorNet-${{ needs.prepare.outputs.version }}-linux.tar.gz .

      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: artifacts/ViorNet-${{ needs.prepare.outputs.version }}-linux.tar.gz
          retention-days: 1

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6 â”€ PUBLISH GITHUB RELEASE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: Publish GitHub Release
    needs: [ prepare, android, ios, web, windows, linux ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -lh release-artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: "ViorNet ${{ needs.prepare.outputs.version }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ViorNet ${{ needs.prepare.outputs.version }}

            **WiFi Reseller & ISP Management System**
            Developed and maintained by **Pritech Vior Softech**

            ---

            ### Downloads

            | Platform | File |
            |---|---|
            | ðŸ¤– Android | `ViorNet-${{ needs.prepare.outputs.version }}-android.apk` |
            | ðŸŽ iOS | `ViorNet-${{ needs.prepare.outputs.version }}-ios.ipa` |
            | ðŸŒ Web | `ViorNet-${{ needs.prepare.outputs.version }}-web.zip` |
            | ðŸªŸ Windows | `ViorNet-${{ needs.prepare.outputs.version }}-windows.zip` |
            | ðŸ§ Linux | `ViorNet-${{ needs.prepare.outputs.version }}-linux.tar.gz` |

            ---
            > Built from commit: `${{ github.sha }}`
            > Triggered by: `${{ github.event.head_commit.message }}`
          files: |
            release-artifacts/*.apk
            release-artifacts/*.ipa
            release-artifacts/*.zip
            release-artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
